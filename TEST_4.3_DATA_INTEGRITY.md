# TEST 4.3: Целостность Данных (End-to-End)

## Описание

End-to-End тест целостности данных: проверка, что данные после парсинга **полностью совпадают** с данными, которые передаются в AI-стратега.

## DoD (Definition of Done)

✅ **Данные в логе после парсинга полностью совпадают с данными, отправленными в AI**

- Название товара, цена, рейтинг, отзывы (из `/analyze`) → должны попасть в `userEvidence` (в `/strategize`)
- Данные о конкурентах (из `/analyze`) → должны попасть в `competitorsEvidence` (в `/strategize`)
- Никакие данные не должны теряться, искажаться или дублироваться

## Почему это важно?

**Проблема:** Если парсер извлёк "Цена: 2990₽", а AI получит "Цена: 29900₽" или вообще не получит цену — стратегия будет **неверной**.

**Риски при нарушении целостности:**
- AI даст неправильные советы (например, "снизьте цену" когда она и так низкая)
- Пользователь примет решение на основе искажённых данных
- Потеря доверия к сервису

## Архитектура потока данных

```
┌─────────────┐
│  Маркетплейс│  ← HTML-страница товара
│  (Ozon/WB)  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Парсер     │  ← Извлечение: title, price, rating, reviews
│  (server.js)│
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Логирование│  ← [TEST 4.3] Checkpoint 1: Данные после парсинга
│  #1         │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Формат-    │  ← Преобразование в userEvidence + competitorsEvidence
│  ирование   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Логирование│  ← [TEST 4.3] Checkpoint 2: Данные перед AI
│  #2         │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  AI Gemini  │  ← Генерация стратегии
│  (API)      │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Ответ      │  ← Стратегия с рекомендациями
│  пользователю│
└─────────────┘
```

## Где добавлено логирование

### Checkpoint 1: После парсинга (`/analyze`)

**Файл:** `server.js`, строки ~280-293  
**Когда:** Сразу после вызова `parseFn(payload.productUrl)`

```javascript
// 🧪 TEST 4.3: Логирование после парсинга
console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
console.log('🔍 [TEST 4.3] ДАННЫЕ ПОСЛЕ ПАРСИНГА (/analyze)');
console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
console.log('📦 Товар:');
console.log(`   Название: ${productSnapshot.title}`);
console.log(`   Цена:     ${productSnapshot.price} руб`);
console.log(`   Рейтинг:  ${productSnapshot.rating} ★`);
console.log(`   Отзывы:   ${productSnapshot.reviews}`);
console.log(`   Статус:   ${productSnapshot.availability}`);
console.log(`\n👥 Конкуренты: ${competitors.length} шт`);
competitors.forEach((c, idx) => {
  console.log(`   ${idx + 1}. ${c.title} - ${c.price} руб, ${c.rating} ★, ${c.reviews} отзывов`);
});
console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
```

### Checkpoint 2: Перед отправкой в AI (`/strategize`)

**Файл:** `server.js`, строки ~781-794  
**Когда:** После валидации `strategizeSchema.parse()`, перед вызовом `generateRealAiStrategy()`

```javascript
// 🧪 TEST 4.3: Логирование перед отправкой в AI
console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
console.log('🤖 [TEST 4.3] ДАННЫЕ ПЕРЕД ОТПРАВКОЙ В AI (/strategize)');
console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
console.log('📊 Наши факты (userEvidence):');
payload.userEvidence.forEach((fact, idx) => {
  console.log(`   ${idx + 1}. ${fact}`);
});
console.log('\n🎯 Факты о конкурентах (competitorsEvidence):');
payload.competitorsEvidence.forEach((fact, idx) => {
  console.log(`   ${idx + 1}. ${fact}`);
});
console.log(`\n⚙️  Тональность: ${payload.tone}`);
console.log(`⚙️  Фокус: ${payload.focus.length > 0 ? payload.focus.join(', ') : 'общий'}`);
console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
```

## Как проводить тест

### Автоматический тест (рекомендуется)

```powershell
# Windows PowerShell
powershell -ExecutionPolicy Bypass -File scripts/test-data-integrity.ps1
```

**Что делает скрипт:**
1. Запускает сервер в фоне
2. Отправляет запрос на `/analyze` (парсинг товара)
3. Извлекает данные из ответа
4. Формирует запрос на `/strategize` с этими данными
5. Сравнивает логи в консоли:
   - Checkpoint 1 (после парсинга)
   - Checkpoint 2 (перед AI)
6. Выводит результат: ✅ PASS / ❌ FAIL

### Ручной тест

#### Шаг 1: Запустить сервер

```powershell
node server.js
```

#### Шаг 2: Отправить запрос на анализ

```powershell
$response = Invoke-RestMethod -Uri "http://localhost:3000/analyze?url=https://www.ozon.ru/product/example&marketplace=ozon&withCompetitors=true" -Method GET
```

**Ожидаемый лог в консоли (Checkpoint 1):**

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 [TEST 4.3] ДАННЫЕ ПОСЛЕ ПАРСИНГА (/analyze)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📦 Товар:
   Название: Ozon Test Product
   Цена:     3990 руб
   Рейтинг:  4.5 ★
   Отзывы:   120
   Статус:   В наличии

👥 Конкуренты: 3 шт
   1. Конкурент — базовая модель - 3790 руб, 4.3 ★, 95 отзывов
   2. Конкурент — улучшенная версия - 4790 руб, 4.6 ★, 200 отзывов
   3. Конкурент — премиум - 5990 руб, 4.8 ★, 350 отзывов
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### Шаг 3: Сформировать запрос на AI-стратегию

Используя данные из шага 2:

```powershell
$body = @{
  userEvidence = @(
    "Наш товар: Ozon Test Product",
    "Наша цена: 3990 руб",
    "Наш рейтинг: 4.5 (120 отзывов)",
    "Статус: В наличии"
  )
  competitorsEvidence = @(
    "Конкурент 1: Конкурент — базовая модель, цена 3790 руб, рейтинг 4.3 (95 отзывов)",
    "Конкурент 2: Конкурент — улучшенная версия, цена 4790 руб, рейтинг 4.6 (200 отзывов)",
    "Конкурент 3: Конкурент — премиум, цена 5990 руб, рейтинг 4.8 (350 отзывов)"
  )
  tone = "analytical"
  focus = @("pricing", "marketing")
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:3000/strategize" -Method POST -Body $body -ContentType "application/json"
```

**Ожидаемый лог в консоли (Checkpoint 2):**

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🤖 [TEST 4.3] ДАННЫЕ ПЕРЕД ОТПРАВКОЙ В AI (/strategize)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 Наши факты (userEvidence):
   1. Наш товар: Ozon Test Product
   2. Наша цена: 3990 руб
   3. Наш рейтинг: 4.5 (120 отзывов)
   4. Статус: В наличии

🎯 Факты о конкурентах (competitorsEvidence):
   1. Конкурент 1: Конкурент — базовая модель, цена 3790 руб, рейтинг 4.3 (95 отзывов)
   2. Конкурент 2: Конкурент — улучшенная версия, цена 4790 руб, рейтинг 4.6 (200 отзывов)
   3. Конкурент 3: Конкурент — премиум, цена 5990 руб, рейтинг 4.8 (350 отзывов)

⚙️  Тональность: analytical
⚙️  Фокус: pricing, marketing
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### Шаг 4: Проверить целостность данных

**Чеклист:**

| Параметр | Checkpoint 1 (парсинг) | Checkpoint 2 (AI) | Совпадение? |
|----------|------------------------|-------------------|-------------|
| Название товара | "Ozon Test Product" | "Наш товар: Ozon Test Product" | ✅ |
| Цена | 3990 руб | "Наша цена: 3990 руб" | ✅ |
| Рейтинг | 4.5 ★ | "Наш рейтинг: 4.5" | ✅ |
| Отзывы | 120 | "120 отзывов" | ✅ |
| Конкурент 1 цена | 3790 руб | "цена 3790 руб" | ✅ |
| Конкурент 1 рейтинг | 4.3 ★ | "рейтинг 4.3" | ✅ |
| Конкурент 2 цена | 4790 руб | "цена 4790 руб" | ✅ |
| Конкурент 3 цена | 5990 руб | "цена 5990 руб" | ✅ |

**Результат:** ✅ **PASS** (все 8/8 параметров совпадают)

## Критерии PASS/FAIL

### ✅ PASS (DoD выполнен)

**Все данные из Checkpoint 1 присутствуют в Checkpoint 2:**

- Название товара сохранено
- Цена не искажена (3990 → 3990, не 39900 или 399)
- Рейтинг корректный (4.5 → 4.5, не 4.50000)
- Количество отзывов совпадает (120 → 120)
- Все конкуренты учтены (3 → 3)
- Цены конкурентов не изменены
- Рейтинги конкурентов не изменены

### ❌ FAIL (DoD не выполнен)

**Хотя бы один из случаев:**

1. **Потеря данных:**
   - В Checkpoint 1: "Цена: 3990 руб"
   - В Checkpoint 2: цена отсутствует
   - **Причина:** Данные не попали в `userEvidence`

2. **Искажение данных:**
   - В Checkpoint 1: "Рейтинг: 4.5 ★"
   - В Checkpoint 2: "Рейтинг: 4.500000001"
   - **Причина:** Ошибка округления при форматировании

3. **Дублирование данных:**
   - В Checkpoint 1: 3 конкурента
   - В Checkpoint 2: 6 конкурентов (каждый дважды)
   - **Причина:** Баг в `buildCompetitorSummary()`

4. **Неправильная типизация:**
   - В Checkpoint 1: `price: 3990` (число)
   - В Checkpoint 2: `price: "3990руб"` (строка без пробела)
   - **Причина:** Неправильный шаблон в `userEvidence`

## Типичные ошибки (примеры)

### ❌ Ошибка 1: Потеря точности при преобразовании

**Проблема:**
```javascript
// Checkpoint 1
price: 2990.99

// Checkpoint 2
userEvidence: ["Наша цена: 2990 руб"] // ❌ Потерялись копейки
```

**Решение:** Использовать `.toFixed(2)` для цен с копейками.

### ❌ Ошибка 2: Некорректный формат строки

**Проблема:**
```javascript
// Checkpoint 1
rating: 4.5
reviews: 120

// Checkpoint 2
userEvidence: ["Рейтинг 4.5120 отзывов"] // ❌ Склеились без разделителя
```

**Решение:** Использовать шаблоны с чёткими разделителями:
```javascript
`Рейтинг: ${rating} (${reviews} отзывов)`
```

### ❌ Ошибка 3: Некорректная обработка `null`

**Проблема:**
```javascript
// Checkpoint 1
availability: null // Товара нет в наличии

// Checkpoint 2
userEvidence: ["Статус: undefined"] // ❌ null превратился в undefined
```

**Решение:** Обработать `null`:
```javascript
availability: productSnapshot.availability || 'Нет данных'
```

## Связанные тесты

- **[Test 1.2: Empty Data](TEST_1.2_EMPTY_DATA.md)** - обработка пустых данных (связь: что если парсер вернул `null`?)
- **[Test 2.1: AI Format](TEST_2.1_AI_FORMAT.md)** - валидация формата AI (связь: AI получает корректные данные?)
- **[Test 4.2: AI Expert Evaluation](TEST_4.2_AI_EXPERT_EVALUATION.md)** - качество AI-советов (связь: советы зависят от корректности входных данных)

## Дополнительная проверка: E2E через UI

### Сценарий (через фронтенд)

1. Откройте `index.html` в браузере
2. Перейдите на вкладку "Анализ товара"
3. Вставьте URL: `https://www.ozon.ru/product/example`
4. Выберите маркетплейс: Ozon
5. Нажмите "Анализировать"
6. **Смотрите терминал с сервером** → Checkpoint 1 появится
7. Перейдите на вкладку "AI-Стратег"
8. Скопируйте данные из результата анализа
9. Вставьте в форму "AI-Стратег"
10. Нажмите "Сгенерировать стратегию"
11. **Смотрите терминал** → Checkpoint 2 появится
12. Сравните Checkpoint 1 и Checkpoint 2

**Ожидаемое поведение:** Все данные из Checkpoint 1 присутствуют в Checkpoint 2 без искажений.

## Примечания

### Зачем два checkpoint'а?

**Checkpoint 1 (после парсинга):**
- Показывает "сырые" данные из парсера
- Формат: объект JavaScript (`productSnapshot`, `competitors[]`)

**Checkpoint 2 (перед AI):**
- Показывает данные после преобразования в текстовый формат
- Формат: массивы строк (`userEvidence[]`, `competitorsEvidence[]`)

**Критический этап:** Преобразование объекта → массив строк. Здесь возможны ошибки форматирования.

### Как отключить логирование (после тестирования)?

Закомментируйте блоки с `console.log('[TEST 4.3]')`:

```javascript
// 🧪 TEST 4.3: Логирование после парсинга
// console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
// console.log('🔍 [TEST 4.3] ДАННЫЕ ПОСЛЕ ПАРСИНГА (/analyze)');
// ...
```

Или используйте условие:

```javascript
const ENABLE_TEST_LOGS = process.env.NODE_ENV !== 'production';

if (ENABLE_TEST_LOGS) {
  console.log('🔍 [TEST 4.3] ДАННЫЕ ПОСЛЕ ПАРСИНГА (/analyze)');
  // ...
}
```

---

## Результат теста

**Дата:** 8 октября 2025 г.  
**Статус:** ✅ READY (логирование добавлено)  
**Версия:** 1.0

### Шаблон отчёта

```markdown
## Test 4.3: Целостность данных (E2E)

Дата: 8 октября 2025 г.
Метод: Ручной тест (анализ логов)

### Checkpoint 1: Данные после парсинга
Товар: Ozon Test Product
Цена: 3990 руб
Рейтинг: 4.5 ★
Отзывы: 120
Конкуренты: 3 шт

### Checkpoint 2: Данные перед AI
userEvidence:
- Наш товар: Ozon Test Product ✅
- Наша цена: 3990 руб ✅
- Наш рейтинг: 4.5 (120 отзывов) ✅

competitorsEvidence:
- Конкурент 1: цена 3790 руб, рейтинг 4.3 ✅
- Конкурент 2: цена 4790 руб, рейтинг 4.6 ✅
- Конкурент 3: цена 5990 руб, рейтинг 4.8 ✅

### Результат
✅ PASS - Все данные совпадают (8/8 параметров)
DoD выполнен: данные после парсинга полностью совпадают с данными перед AI
```

---

**Статус:** ✅ Готов к тестированию  
**Автор:** GitHub Copilot  
**Связь:** Test 1.2 (Empty Data), Test 2.1 (AI Format), Test 4.2 (AI Expert)
