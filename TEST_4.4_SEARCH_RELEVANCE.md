# TEST 4.4: Релевантность Поиска

## Описание

Ручной тест качества поиска: проверка, что функция "Поиск по топу" возвращает **релевантные** товары, соответствующие запросу пользователя.

## DoD (Definition of Done)

✅ **По запросу "рубашка мужская белая" в выдаче нет футболок**

- Результаты поиска соответствуют запросу
- Нет товаров из других категорий (футболки, брюки, обувь)
- Нет товаров другого цвета (если указан цвет)
- Нет товаров другого пола (если указан пол)

## Почему это важно?

**Проблема:** Если поиск по запросу "рубашка мужская белая" возвращает футболки, женские блузки или цветные рубашки — пользователь потеряет время и доверие к сервису.

**Последствия нерелевантного поиска:**
- Пользователь не найдёт нужный товар
- Пустая трата времени на фильтрацию вручную
- Снижение конверсии
- Потеря доверия к AI-аналитике

## Текущая реализация поиска

### Где находится код?

**Файл:** `server.js`  
**Функция:** `searchLocalDataset(query, marketplace, limit)`  
**Эндпоинт:** `GET /search?query=...&marketplace=...&limit=...`

### Как работает сейчас?

```javascript
function searchLocalDataset(query, marketplace, limit) {
  const normalizedQuery = query.toLowerCase();
  const marketplaces = marketplace ? [marketplace] : Object.keys(localCatalog);
  const results = [];

  marketplaces.forEach((mp) => {
    const candidates = localCatalog[mp] || [];
    candidates.forEach((item) => {
      if (results.length >= limit) return;
      // Простой поиск по substring в названии или категории
      if (item.title.toLowerCase().includes(normalizedQuery) || 
          item.category.toLowerCase().includes(normalizedQuery)) {
        results.push({ marketplace: mp, ...item });
      }
    });
  });

  return results.slice(0, limit);
}
```

**Метод:** Простой поиск по подстроке (`includes()`)

**Проблемы текущей реализации:**
- ❌ Нет учёта синонимов (shirt ≠ рубашка)
- ❌ Нет учёта опечаток (рубашка ≠ рубшака)
- ❌ Нет ранжирования по релевантности
- ❌ Нет фильтрации по атрибутам (цвет, пол, размер)

## Как проводить тест

### Подготовка

1. **Запустите сервер:**
   ```powershell
   node server.js
   ```

2. **Откройте браузер** или используйте Postman/PowerShell

### Тестовые сценарии

#### Сценарий 1: Базовый запрос (проверка DoD)

**Запрос:** `рубашка мужская белая`

**Команда:**
```powershell
$response = Invoke-RestMethod -Uri "http://localhost:3000/search?query=рубашка+мужская+белая&limit=10" -Method GET
$response | ConvertTo-Json -Depth 5
```

**Ожидаемый результат:**
```json
{
  "results": [
    {
      "marketplace": "ozon",
      "title": "Рубашка мужская белая классическая",
      "category": "Мужская одежда > Рубашки",
      "price": 2990,
      "rating": 4.7
    },
    {
      "marketplace": "wildberries",
      "title": "Мужская рубашка белая приталенная",
      "category": "Одежда > Мужчинам > Рубашки",
      "price": 1990,
      "rating": 4.5
    }
  ],
  "query": "рубашка мужская белая",
  "totalResults": 2
}
```

**Чек-лист проверки:**

| Критерий | ✅/❌ | Комментарий |
|----------|------|-------------|
| **1. Все результаты — рубашки** | ☐ | Нет футболок, брюк, обуви |
| **2. Все результаты — мужские** | ☐ | Нет женских блузок, детских рубашек |
| **3. Все результаты — белые** | ☐ | Нет чёрных, синих, цветных |
| **4. Категория корректна** | ☐ | "Рубашки" или "Мужская одежда" |
| **5. Нет товаров из других категорий** | ☐ | Нет "Футболки", "Поло", "Джинсы" |

**Результат:** ✅ PASS (все 5 критериев выполнены) / ❌ FAIL (хотя бы 1 критерий не выполнен)

---

#### Сценарий 2: Запрос с уточнением (slim fit)

**Запрос:** `рубашка мужская белая slim fit`

**Команда:**
```powershell
$response = Invoke-RestMethod -Uri "http://localhost:3000/search?query=рубашка+мужская+белая+slim+fit&limit=10" -Method GET
$response.results | ForEach-Object { Write-Host "$($_.title) - $($_.category)" }
```

**Ожидаемый результат:**
- Рубашки с приталенным кроем (slim fit / приталенная / зауженная)
- Все белые, мужские

**Чек-лист проверки:**

| Критерий | ✅/❌ | Комментарий |
|----------|------|-------------|
| **1. Приоритет товарам со "slim fit"** | ☐ | Товары с "slim fit" идут первыми |
| **2. Нет товаров с "regular fit"** | ☐ | Или они внизу результатов |
| **3. Рубашки + белый цвет + мужские** | ☐ | Базовые критерии сохранены |

**Результат:** ✅ PASS / ❌ FAIL

---

#### Сценарий 3: Запрос на другом языке (English)

**Запрос:** `white men shirt`

**Команда:**
```powershell
$response = Invoke-RestMethod -Uri "http://localhost:3000/search?query=white+men+shirt&limit=10" -Method GET
$response.results | Select-Object title, category
```

**Ожидаемый результат:**
- Если в каталоге есть товары с английскими названиями — найти их
- Если нет — пустой результат (корректное поведение)

**Проблема:** Текущая реализация не переводит запрос, поэтому "white men shirt" НЕ найдёт "рубашка мужская белая"

**Чек-лист проверки:**

| Критерий | ✅/❌ | Комментарий |
|----------|------|-------------|
| **1. Нашлись товары на английском** | ☐ | Если есть в базе |
| **2. Нет нерелевантных товаров** | ☐ | Не нашлись случайные товары |
| **3. Пустой результат допустим** | ☐ | Если база только на русском |

**Результат:** ✅ PASS / ⚠️ ACCEPTABLE / ❌ FAIL

---

#### Сценарий 4: Запрос с опечаткой

**Запрос:** `рубшака мужская` (опечатка: "рубшака" вместо "рубашка")

**Команда:**
```powershell
$response = Invoke-RestMethod -Uri "http://localhost:3000/search?query=рубшака+мужская&limit=10" -Method GET
$response.totalResults
```

**Ожидаемый результат:**
- Если поиск не находит ничего → ❌ FAIL (нет обработки опечаток)
- Если находит рубашки → ✅ PASS (есть fuzzy search)

**Чек-лист проверки:**

| Критерий | ✅/❌ | Комментарий |
|----------|------|-------------|
| **1. Найдены рубашки несмотря на опечатку** | ☐ | Fuzzy search работает |
| **2. Если ничего не найдено — есть подсказка** | ☐ | "Возможно, вы имели в виду: рубашка" |

**Результат:** ✅ PASS (найдены) / ⚠️ ACCEPTABLE (подсказка есть) / ❌ FAIL (пусто без подсказки)

---

#### Сценарий 5: Запрос с излишней специфичностью

**Запрос:** `рубашка мужская белая хлопок 100% размер 42 воротник 39`

**Команда:**
```powershell
$response = Invoke-RestMethod -Uri "http://localhost:3000/search?query=рубашка+мужская+белая+хлопок+100%+размер+42+воротник+39&limit=10" -Method GET
$response.totalResults
```

**Ожидаемый результат:**
- Найдены белые мужские рубашки (базовые критерии)
- Дополнительные фильтры (размер, состав) игнорируются или применяются частично

**Чек-лист проверки:**

| Критерий | ✅/❌ | Комментарий |
|----------|------|-------------|
| **1. Найдены рубашки** | ☐ | Не пустой результат |
| **2. Базовые критерии соблюдены** | ☐ | Белые, мужские |
| **3. Специфичные фильтры не блокируют поиск** | ☐ | Даже если размер не совпал |

**Результат:** ✅ PASS / ❌ FAIL

---

#### Сценарий 6: Запрос с категорией вместо товара

**Запрос:** `мужская одежда`

**Команда:**
```powershell
$response = Invoke-RestMethod -Uri "http://localhost:3000/search?query=мужская+одежда&limit=10" -Method GET
$response.results | Select-Object title, category | Format-Table
```

**Ожидаемый результат:**
- Найдены товары из категории "Мужская одежда"
- Могут быть: рубашки, брюки, куртки, футболки и т.д.

**Чек-лист проверки:**

| Критерий | ✅/❌ | Комментарий |
|----------|------|-------------|
| **1. Все товары — мужские** | ☐ | Нет женской одежды |
| **2. Категория содержит "Мужская одежда"** | ☐ | Или подкатегории |
| **3. Разнообразие товаров** | ☐ | Не только рубашки |

**Результат:** ✅ PASS / ❌ FAIL

---

#### Сценарий 7: Нерелевантный запрос (негативный тест)

**Запрос:** `автомобиль BMW`

**Команда:**
```powershell
$response = Invoke-RestMethod -Uri "http://localhost:3000/search?query=автомобиль+BMW&limit=10" -Method GET
$response.totalResults
```

**Ожидаемый результат:**
- Пустой результат (0 товаров)
- Сообщение: "Ничего не найдено" или "Попробуйте другой запрос"

**Чек-лист проверки:**

| Критерий | ✅/❌ | Комментарий |
|----------|------|-------------|
| **1. Результат пустой** | ☐ | 0 товаров |
| **2. Нет случайных товаров** | ☐ | Не нашлись "авточехлы" или "игрушечные машинки" |
| **3. Есть понятное сообщение** | ☐ | "Ничего не найдено" |

**Результат:** ✅ PASS / ❌ FAIL

---

## Общий чек-лист для всех запросов

### Критерии релевантности

| № | Критерий | Вес | Описание |
|---|----------|-----|----------|
| 1 | **Соответствие категории** | 40% | Товар из той же категории, что указана в запросе |
| 2 | **Соответствие атрибутов** | 30% | Цвет, пол, размер, бренд соответствуют запросу |
| 3 | **Соответствие ключевым словам** | 20% | Все ключевые слова из запроса присутствуют в названии/описании |
| 4 | **Отсутствие шума** | 10% | Нет товаров из других категорий |

### Шкала оценки

**Для каждого сценария:**

- **10/10** — Все результаты 100% релевантны
- **8-9/10** — 1-2 нерелевантных товара из 10
- **6-7/10** — 3-4 нерелевантных товара из 10
- **4-5/10** — Половина результатов нерелевантны
- **0-3/10** — Поиск не работает / все результаты нерелевантны

### Итоговая оценка теста

**DoD выполнен, если:**

1. ✅ Сценарий 1 (базовый) — 9/10 или выше
2. ✅ Сценарий 2 (уточнение) — 8/10 или выше
3. ✅ Сценарий 7 (негативный) — 10/10 (пустой результат)

**DoD НЕ выполнен, если:**

- ❌ Сценарий 1 < 8/10 (в выдаче есть футболки/нерелевантные товары)
- ❌ Сценарий 7 вернул нерелевантные товары (BMW → нашёл рубашки)

## Примеры нерелевантных результатов

### ❌ Плохо: Нерелевантные результаты

**Запрос:** `рубашка мужская белая`

**Плохой результат:**
```json
{
  "results": [
    {
      "title": "Футболка мужская белая", // ❌ Футболка, не рубашка
      "category": "Футболки"
    },
    {
      "title": "Рубашка женская белая", // ❌ Женская, не мужская
      "category": "Женская одежда"
    },
    {
      "title": "Рубашка мужская чёрная", // ❌ Чёрная, не белая
      "category": "Рубашки"
    },
    {
      "title": "Брюки мужские белые", // ❌ Брюки, не рубашка
      "category": "Брюки"
    }
  ]
}
```

**Проблемы:**
- 0 из 4 товаров релевантны
- Оценка: 0/10
- DoD не выполнен

---

### ✅ Хорошо: Релевантные результаты

**Запрос:** `рубашка мужская белая`

**Хороший результат:**
```json
{
  "results": [
    {
      "title": "Рубашка мужская белая классическая",
      "category": "Мужская одежда > Рубашки",
      "price": 2990,
      "rating": 4.7
    },
    {
      "title": "Мужская рубашка белая приталенная slim fit",
      "category": "Одежда > Мужчинам > Рубашки",
      "price": 1990,
      "rating": 4.5
    },
    {
      "title": "Рубашка для мужчин белая длинный рукав",
      "category": "Мужские рубашки",
      "price": 2490,
      "rating": 4.6
    }
  ]
}
```

**Почему хорошо:**
- ✅ Все 3 товара — рубашки
- ✅ Все 3 товара — мужские
- ✅ Все 3 товара — белые
- ✅ Категории корректны
- Оценка: 10/10
- DoD выполнен

---

## Как улучшить релевантность (рекомендации)

### Проблема 1: Простой `includes()` ловит всё подряд

**Текущий код:**
```javascript
if (item.title.toLowerCase().includes(normalizedQuery))
```

**Проблема:** Запрос "рубашка" найдёт "футболка" (contains "ка")

**Решение 1: Токенизация**
```javascript
const queryTokens = normalizedQuery.split(' ');
const titleTokens = item.title.toLowerCase().split(' ');

const matchCount = queryTokens.filter(qt => 
  titleTokens.some(tt => tt.includes(qt))
).length;

const relevance = matchCount / queryTokens.length;
if (relevance >= 0.5) { // Хотя бы 50% слов совпали
  results.push({ ...item, relevance });
}
```

**Решение 2: Стоп-слова**
```javascript
const stopWords = ['футболка', 'поло', 'джинсы', 'брюки'];
if (normalizedQuery.includes('рубашка')) {
  const hasStopWord = stopWords.some(sw => item.title.toLowerCase().includes(sw));
  if (hasStopWord) return; // Пропустить
}
```

---

### Проблема 2: Нет учёта атрибутов (цвет, пол)

**Текущий код:** Ищет только по `title` и `category`

**Решение: Парсинг атрибутов из запроса**
```javascript
function extractAttributes(query) {
  const colors = ['белый', 'чёрный', 'синий', 'красный'];
  const genders = ['мужской', 'женский', 'детский'];
  
  const foundColor = colors.find(c => query.includes(c));
  const foundGender = genders.find(g => query.includes(g));
  
  return { color: foundColor, gender: foundGender };
}

// Использование:
const attrs = extractAttributes(normalizedQuery);
candidates.forEach((item) => {
  if (attrs.color && !item.title.includes(attrs.color)) return;
  if (attrs.gender && !item.title.includes(attrs.gender)) return;
  // ...
});
```

---

### Проблема 3: Нет ранжирования

**Текущий код:** Все результаты равнозначны

**Решение: Система скоринга**
```javascript
function calculateRelevance(item, query) {
  let score = 0;
  
  // +5 если точное совпадение
  if (item.title.toLowerCase() === query.toLowerCase()) score += 5;
  
  // +3 если все слова запроса в названии
  const queryWords = query.split(' ');
  const titleWords = item.title.toLowerCase().split(' ');
  const allWordsMatch = queryWords.every(qw => 
    titleWords.some(tw => tw.includes(qw))
  );
  if (allWordsMatch) score += 3;
  
  // +2 если категория совпадает
  if (item.category.toLowerCase().includes(query.split(' ')[0])) score += 2;
  
  // +1 за высокий рейтинг
  if (item.rating >= 4.5) score += 1;
  
  return score;
}

// Сортировка по релевантности
results.sort((a, b) => b.relevance - a.relevance);
```

---

## Автоматизация теста (будущее)

### Идея: Автоматический тест релевантности

```powershell
# test-search-relevance.ps1

$testCases = @(
  @{ query = "рубашка мужская белая"; mustInclude = @("рубашка", "мужск", "бел"); mustExclude = @("футболка", "женск", "чёрн") },
  @{ query = "автомобиль BMW"; expectedEmpty = $true }
)

foreach ($test in $testCases) {
  $response = Invoke-RestMethod -Uri "http://localhost:3000/search?query=$($test.query)&limit=10" -Method GET
  
  if ($test.expectedEmpty -and $response.totalResults -eq 0) {
    Write-Host "✅ PASS: '$($test.query)' вернул пустой результат" -ForegroundColor Green
  }
  elseif ($test.mustInclude) {
    $allMatch = $response.results | ForEach-Object {
      $title = $_.title.ToLower()
      $test.mustInclude | ForEach-Object { $title.Contains($_) }
    }
    
    if ($allMatch -notcontains $false) {
      Write-Host "✅ PASS: '$($test.query)' все результаты релевантны" -ForegroundColor Green
    }
    else {
      Write-Host "❌ FAIL: '$($test.query)' есть нерелевантные результаты" -ForegroundColor Red
    }
  }
}
```

---

## Шаблон отчёта

```markdown
## Test 4.4: Релевантность поиска

Дата: 8 октября 2025 г.
Метод: Ручной тест (7 сценариев)

### Сценарий 1: Базовый запрос (DoD)
Запрос: "рубашка мужская белая"
Результат: 5 товаров найдено
Релевантность: 5/5 (100%)
- ✅ Все рубашки
- ✅ Все мужские
- ✅ Все белые
Оценка: 10/10 ✅ PASS

### Сценарий 2: Уточнение (slim fit)
Запрос: "рубашка мужская белая slim fit"
Результат: 3 товара найдено
Релевантность: 2/3 (67%)
- ✅ 2 товара со "slim fit"
- ❌ 1 товар "regular fit" (попал случайно)
Оценка: 7/10 ⚠️ ACCEPTABLE

### Сценарий 7: Негативный тест
Запрос: "автомобиль BMW"
Результат: 0 товаров (пустой)
Оценка: 10/10 ✅ PASS

### Итого:
DoD: ✅ ВЫПОЛНЕН (сценарий 1 = 10/10, нет футболок в выдаче)
Средняя оценка: 9/10
Рекомендации: Добавить фильтрацию по атрибутам (slim fit, regular fit)
```

---

## Связанные тесты

- **Test 1.2: Empty Data** - что делать, если база товаров пустая?
- **Test 4.3: Data Integrity** - данные из поиска корректны для AI?

---

**Статус:** ✅ Готов к ручному тестированию  
**Дата:** 8 октября 2025 г.  
**Версия:** 1.0  
**Тип:** Ручной тест (требует экспертной оценки релевантности)
