# TEST 4.3: Целостность данных - Краткая инструкция

## Что проверяем?

**DoD:** Данные после парсинга полностью совпадают с данными, отправленными в AI.

## Быстрый запуск

### Вариант 1: Автоматический (рекомендуется)

```powershell
# 1. Запустите сервер в одном терминале
node server.js

# 2. В другом терминале запустите тест
powershell -ExecutionPolicy Bypass -File scripts/test-data-integrity.ps1
```

**Смотрите на терминал с сервером!** Там появятся логи:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 [TEST 4.3] ДАННЫЕ ПОСЛЕ ПАРСИНГА (/analyze)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📦 Товар:
   Название: Товар на Ozon
   Цена:     3990 руб
   Рейтинг:  4.5 ★
   Отзывы:   120
   Статус:   В наличии

👥 Конкуренты: 3 шт
   1. Конкурент 1 - 3790 руб, 4.3 ★, 95 отзывов
   2. Конкурент 2 - 4790 руб, 4.6 ★, 200 отзывов
   3. Конкурент 3 - 5990 руб, 4.8 ★, 350 отзывов
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

(далее через несколько секунд)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🤖 [TEST 4.3] ДАННЫЕ ПЕРЕД ОТПРАВКОЙ В AI (/strategize)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 Наши факты (userEvidence):
   1. Наш товар: Товар на Ozon
   2. Наша цена: 3990 руб
   3. Наш рейтинг: 4.5 (120 отзывов)

🎯 Факты о конкурентах (competitorsEvidence):
   1. Конкурент: Конкурент 1, цена 3790 руб, рейтинг 4.3 (95 отзывов)
   2. Конкурент: Конкурент 2, цена 4790 руб, рейтинг 4.6 (200 отзывов)
   3. Конкурент: Конкурент 3, цена 5990 руб, рейтинг 4.8 (350 отзывов)

⚙️  Тональность: analytical
⚙️  Фокус: pricing, marketing
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Что проверять?

| Параметр | Checkpoint 1 | Checkpoint 2 | Совпадает? |
|----------|--------------|--------------|------------|
| Название | "Товар на Ozon" | "Наш товар: Товар на Ozon" | ✅ |
| Цена | 3990 руб | "Наша цена: 3990 руб" | ✅ |
| Рейтинг | 4.5 ★ | "Наш рейтинг: 4.5" | ✅ |
| Отзывы | 120 | "120 отзывов" | ✅ |
| Конкурент 1 цена | 3790 руб | "цена 3790 руб" | ✅ |
| Конкурент 2 цена | 4790 руб | "цена 4790 руб" | ✅ |
| Конкурент 3 цена | 5990 руб | "цена 5990 руб" | ✅ |

**Результат:** ✅ PASS (все данные совпадают)

### Вариант 2: Ручной (через Postman/curl)

```powershell
# Шаг 1: Анализ товара
$response = Invoke-RestMethod -Uri "http://localhost:3000/analyze?url=https://www.ozon.ru/product/example&marketplace=ozon&withCompetitors=true" -Method GET

# Шаг 2: Смотрите логи в терминале сервера (Checkpoint 1)

# Шаг 3: Отправьте данные в AI
$body = @{
  userEvidence = @(
    "Наш товар: $($response.product.title)",
    "Наша цена: $($response.product.price) руб"
  )
  competitorsEvidence = @(
    "Конкурент: $($response.competitors[0].title), цена $($response.competitors[0].price) руб"
  )
  tone = "analytical"
  focus = @("pricing")
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:3000/strategize" -Method POST -Body $body -ContentType "application/json"

# Шаг 4: Смотрите логи в терминале сервера (Checkpoint 2)
```

## Критерии PASS/FAIL

### ✅ PASS
- Все данные из Checkpoint 1 присутствуют в Checkpoint 2
- Цифры не изменились (3990 → 3990, не 39900)
- Количество конкурентов совпадает (3 → 3)

### ❌ FAIL
- Данные потерялись (цена есть в Checkpoint 1, но нет в Checkpoint 2)
- Данные искажены (4.5 → 4.500000001)
- Дублирование (3 конкурента → 6 конкурентов)

## Что делать, если FAIL?

1. **Потеря данных:** Проверьте формирование `userEvidence` в коде
2. **Искажение:** Проверьте шаблоны форматирования (используйте `.toFixed()` для чисел)
3. **Дублирование:** Проверьте функцию `buildCompetitorSummary()`

## Где искать код?

- **Checkpoint 1:** `server.js`, строки ~280-293 (в маршруте `/analyze`)
- **Checkpoint 2:** `server.js`, строки ~781-794 (в маршруте `/strategize`)

## Документация

Полная инструкция: [TEST_4.3_DATA_INTEGRITY.md](TEST_4.3_DATA_INTEGRITY.md)

---

**Статус:** ✅ READY  
**Время выполнения:** ~5 секунд  
**Тип:** Автоматический + ручная проверка логов
