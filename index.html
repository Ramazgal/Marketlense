<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketLens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; background-color: #030712; }
    .tab-btn.active { background-color: #7C3AED; color: white; }
    .tab-btn:not(.active) { background-color: #374151; color: #d1d5db; }
    .tab-btn:hover { background-color: #4c1d95; color: #f9fafb; }
        #splash-screen { transition: opacity 0.5s ease-out; }
        #splash-logo { animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background-color: #7C3AED; border-radius: 10px; border: 2px solid #1f2937; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <!-- –°–ü–õ–≠–®-–°–ö–†–ò–ù -->
    <div id="splash-screen" class="fixed inset-0 bg-gray-900 flex flex-col justify-center items-center z-50">
        <div id="splash-logo">
            <svg width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.6725 16.6412L21 21M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z" stroke="#7C3AED" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 13V11" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M11 13V7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 13V9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <p class="text-gray-400 mt-4 text-lg font-medium">MarketLens</p>
    </div>

    <div class="w-full max-w-6xl mx-auto p-4 sm:p-6">
        <header class="text-center my-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight">MarketLens</h1>
            <p class="text-gray-400 mt-2 max-w-2xl mx-auto">–í–∞—à AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö</p>
        </header>

        <div class="sticky top-4 z-40 bg-gray-900/50 backdrop-blur-sm">
            <div class="flex justify-center mb-8 bg-gray-800 p-1 rounded-xl max-w-md mx-auto shadow-lg">
                <button data-view="analyze" class="tab-btn active w-1/3 font-semibold py-2 px-4 rounded-lg transition-all duration-300">–ê–Ω–∞–ª–∏–∑</button>
                <button data-view="search" class="tab-btn w-1/3 font-semibold py-2 px-4 rounded-lg transition-all duration-300">–ü–æ–∏—Å–∫</button>
                <button data-view="monitoring" class="tab-btn w-1/3 font-semibold py-2 px-4 rounded-lg transition-all duration-300">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
            </div>
        </div>

        <main id="view-analyze" class="view-content">
            <section class="bg-gray-800/60 backdrop-blur-sm border border-gray-700 rounded-2xl shadow-xl p-6 sm:p-8 space-y-6">
                <div>
                    <h2 class="text-2xl font-semibold">AI-–∞–Ω–∞–ª–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏</h2>
                    <p class="text-gray-400 mt-2">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä —Å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ –∏ –ø–æ–ª—É—á–∏—Ç–µ –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –∏–Ω—Å–∞–π—Ç.</p>
                </div>
                <form id="analyze-form" class="space-y-4">
                    <div class="grid gap-4 sm:grid-cols-[minmax(0,1fr)_200px]">
                        <label class="flex flex-col gap-2">
                            <span class="text-sm font-medium text-gray-300">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä</span>
                            <input id="analyze-url" type="url" placeholder="https://www.ozon.ru/..." class="w-full px-4 py-3 rounded-xl bg-gray-900/80 border border-gray-700 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/40 transition" required>
                        </label>
                        <label class="flex flex-col gap-2">
                            <span class="text-sm font-medium text-gray-300">–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</span>
                            <select id="analyze-marketplace" class="w-full px-4 py-3 rounded-xl bg-gray-900/80 border border-gray-700 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/40 transition">
                                <option value="ozon">Ozon</option>
                                <option value="wildberries">Wildberries</option>
                                <option value="yandex_market">–Ø–Ω–¥–µ–∫—Å –ú–∞—Ä–∫–µ—Ç</option>
                            </select>
                        </label>
                    </div>
                    <label class="flex items-center gap-3 text-sm text-gray-300">
                        <input id="analyze-with-competitors" type="checkbox" class="w-4 h-4 rounded border-gray-600 bg-gray-900/80 text-indigo-500 focus:ring-indigo-500" checked>
                        –î–æ–±–∞–≤–∏—Ç—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–ª–∏–∂–∞–π—à–∏—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
                    </label>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                        <button type="submit" class="analyze-submit inline-flex items-center justify-center px-6 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 transition font-semibold shadow-lg shadow-indigo-600/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
                        <p id="analyze-status" class="text-sm text-gray-400">–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É</p>
                    </div>
                </form>
            </section>
            <section class="mt-10 space-y-4" aria-live="polite">
                <div id="analyze-log" class="hidden bg-gray-800/40 border border-gray-700 rounded-2xl p-6 space-y-3"></div>
            </section>
        </main>
        <main id="view-search" class="view-content hidden">
            <section class="bg-gray-800/60 backdrop-blur-sm border border-gray-700 rounded-2xl shadow-xl p-6 sm:p-8 space-y-6">
                <div>
                    <h2 class="text-2xl font-semibold">–ü–æ–∏—Å–∫ –ª–∏–¥–µ—Ä–æ–≤ –Ω–∏—à–∏</h2>
                    <p class="text-gray-400 mt-2">–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –∏ –ø–æ–ª—É—á–∏—Ç–µ –ª—É—á—à–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏.</p>
                </div>
                <form id="search-form" class="space-y-4">
                    <div class="grid gap-4 sm:grid-cols-[minmax(0,1fr)_200px]">
                        <label class="flex flex-col gap-2">
                            <span class="text-sm font-medium text-gray-300">–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ</span>
                            <input id="search-query" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–º–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞" class="w-full px-4 py-3 rounded-xl bg-gray-900/80 border border-gray-700 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/40 transition" required>
                        </label>
                        <label class="flex flex-col gap-2">
                            <span class="text-sm font-medium text-gray-300">–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</span>
                            <select id="search-marketplace" class="w-full px-4 py-3 rounded-xl bg-gray-900/80 border border-gray-700 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/40 transition">
                                <option value="">–í—Å–µ –ø–ª–æ—â–∞–¥–∫–∏</option>
                                <option value="ozon">Ozon</option>
                                <option value="wildberries">Wildberries</option>
                                <option value="yandex_market">–Ø–Ω–¥–µ–∫—Å –ú–∞—Ä–∫–µ—Ç</option>
                            </select>
                        </label>
                    </div>
                    <div class="flex flex-wrap gap-4 items-center">
                        <label class="flex items-center gap-3 text-sm text-gray-300">
                            <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:</span>
                            <input id="search-limit" type="number" min="1" max="20" value="5" class="w-20 px-3 py-2 rounded-lg bg-gray-900/80 border border-gray-700 focus:border-indigo-500 focus:ring-indigo-500/40 transition">
                        </label>
                        <button type="submit" class="search-submit inline-flex items-center justify-center px-6 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 transition font-semibold shadow-lg shadow-indigo-600/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400">–ù–∞–π—Ç–∏ —Ç–æ–ø-—Ç–æ–≤–∞—Ä—ã</button>
                        <p id="search-status" class="text-sm text-gray-400">–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –≤–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å</p>
                    </div>
                </form>
            </section>
            <section class="mt-10 space-y-4" aria-live="polite">
                <div id="search-results" class="hidden bg-gray-800/40 border border-gray-700 rounded-2xl p-6 space-y-3"></div>
            </section>
        </main>

        <main id="view-monitoring" class="view-content hidden">
            <section class="bg-gray-800/60 backdrop-blur-sm border border-gray-700 rounded-2xl shadow-xl p-6 sm:p-8 space-y-6">
                <div>
                    <h2 class="text-2xl font-semibold">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</h2>
                    <p class="text-gray-400 mt-2">–î–æ–±–∞–≤—å—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤, –∏ –º—ã –ø—Ä–æ—Å–ª–µ–¥–∏–º –∑–∞ –∏—Ö —Ü–µ–Ω–æ–π, —Ä–µ–π—Ç–∏–Ω–≥–æ–º –∏ –æ—Ç–∑—ã–≤–∞–º–∏.</p>
                </div>
                <form id="monitoring-form" class="space-y-4">
                    <div class="grid gap-4 sm:grid-cols-[minmax(0,1fr)_200px]">
                        <label class="flex flex-col gap-2">
                            <span class="text-sm font-medium text-gray-300">–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞</span>
                            <input id="monitoring-url" type="url" placeholder="https://www.wildberries.ru/..." class="w-full px-4 py-3 rounded-xl bg-gray-900/80 border border-gray-700 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/40 transition" required>
                        </label>
                        <label class="flex flex-col gap-2">
                            <span class="text-sm font-medium text-gray-300">–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</span>
                            <select id="monitoring-marketplace" class="w-full px-4 py-3 rounded-xl bg-gray-900/80 border border-gray-700 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/40 transition">
                                <option value="ozon">Ozon</option>
                                <option value="wildberries">Wildberries</option>
                                <option value="yandex_market">–Ø–Ω–¥–µ–∫—Å –ú–∞—Ä–∫–µ—Ç</option>
                            </select>
                        </label>
                    </div>
                    <label class="flex flex-col gap-2">
                        <span class="text-sm font-medium text-gray-300">–ó–∞–º–µ—Ç–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                        <textarea id="monitoring-notes" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç, –¥–µ—Ä–∂–∏—Ç —Ü–µ–Ω—É 2990" class="w-full px-4 py-3 rounded-xl bg-gray-900/80 border border-gray-700 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/40 transition"></textarea>
                    </label>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                        <button type="submit" class="monitoring-submit inline-flex items-center justify-center px-6 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 transition font-semibold shadow-lg shadow-indigo-600/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400">–î–æ–±–∞–≤–∏—Ç—å –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
                        <button type="button" id="check-updates-btn" class="inline-flex items-center justify-center px-6 py-3 rounded-xl bg-green-600 hover:bg-green-500 active:bg-green-700 transition font-semibold shadow-lg shadow-green-600/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-green-400 hidden">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</button>
                        <p id="monitoring-status" class="text-sm text-gray-400">–ï—â—ë –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º</p>
                    </div>
                </form>
            </section>
            <section class="mt-10 space-y-4" aria-live="polite">
                <div id="monitoring-list" class="hidden space-y-4"></div>
            </section>
        </main>
        
        <!-- ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã) ... -->

        <section id="results-container" class="hidden mt-12 bg-gray-800/40 border border-gray-700 rounded-2xl shadow-xl p-6 space-y-4" aria-live="polite"></section>
    </div>
    
    <script>
        const API_BASE_URL = (() => {
            const backendPort = 3000;
            // –î–ª—è GitHub Pages –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
            if (window.location.hostname.includes('github.io')) {
                return 'http://185.91.53.49:3000';
            }
            // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
            const hostname = ['localhost', '127.0.0.1'].includes(window.location.hostname)
                ? 'localhost'
                : window.location.hostname;
            const protocol = window.location.protocol === 'file:' ? 'http:' : window.location.protocol;
            return `${protocol}//${hostname}:${backendPort}`;
        })();

        const originalFetch = window.fetch.bind(window);
        window.fetch = (input, init) => {
            if (typeof input === 'string' && input.startsWith('/')) {
                return originalFetch(new URL(input, API_BASE_URL), init);
            }

            if (input instanceof Request && input.url.startsWith('/')) {
                const requestUrl = new URL(input.url, API_BASE_URL);
                const updatedRequest = new Request(requestUrl, input);
                return originalFetch(updatedRequest, init);
            }

            return originalFetch(input, init);
        };

        console.info('[MarketLens] API base is set to', API_BASE_URL);
        window.MarketLensConfig = { API_BASE_URL };

        const getResultsContainer = () => document.getElementById('results-container');

        const escapeHtml = (value = '') =>
            String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');

        function showLoader(message = '–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...') {
            const container = getResultsContainer();
            if (!container) return;

            container.classList.remove('hidden');
            container.innerHTML = `
                <div class="flex items-center gap-3 text-gray-200">
                    <span class="w-5 h-5 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></span>
                    <span>${message}</span>
                </div>
            `;
        }

        function hideLoader() {
            const container = getResultsContainer();
            if (!container) return;

            container.innerHTML = '';
            container.classList.add('hidden');
        }

        function showResults(htmlContent = '') {
            const container = getResultsContainer();
            if (!container) return;

            container.classList.remove('hidden');
            container.innerHTML = htmlContent;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
            const views = Array.from(document.querySelectorAll('.view-content'));

            const setActiveView = (viewId) => {
                views.forEach((view) => {
                    view.classList.toggle('hidden', view.id !== `view-${viewId}`);
                });

                tabButtons.forEach((btn) => {
                    btn.classList.toggle('active', btn.dataset.view === viewId);
                });
            };

            tabButtons.forEach((button) => {
                button.addEventListener('click', () => setActiveView(button.dataset.view));
            });

            setActiveView('analyze');

            const analyzeForm = document.getElementById('analyze-form');
            const analyzeUrlInput = document.getElementById('analyze-url');
            const analyzeMarketplace = document.getElementById('analyze-marketplace');
            const analyzeWithCompetitors = document.getElementById('analyze-with-competitors');
            const analyzeStatus = document.getElementById('analyze-status');
            const analyzeLog = document.getElementById('analyze-log');
            const searchForm = document.getElementById('search-form');
            const searchQuery = document.getElementById('search-query');
            const searchMarketplace = document.getElementById('search-marketplace');
            const searchLimit = document.getElementById('search-limit');
            const searchStatus = document.getElementById('search-status');
            const searchResults = document.getElementById('search-results');
            const monitoringForm = document.getElementById('monitoring-form');
            const monitoringUrl = document.getElementById('monitoring-url');
            const monitoringMarketplace = document.getElementById('monitoring-marketplace');
            const monitoringNotes = document.getElementById('monitoring-notes');
            const monitoringStatus = document.getElementById('monitoring-status');
            const monitoringList = document.getElementById('monitoring-list');

            if (analyzeForm) {
                const analyzeButton = analyzeForm.querySelector('.analyze-submit');
                analyzeForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    
                    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
                    if (analyzeButton) analyzeButton.disabled = true;

                    try {
                        const productUrl = analyzeUrlInput?.value?.trim();
                        const marketplace = analyzeMarketplace?.value || 'ozon';
                        const withCompetitors = !!analyzeWithCompetitors?.checked;

                        if (!productUrl) {
                            analyzeStatus.textContent = '–î–æ–±–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞';
                            analyzeStatus.classList.remove('text-green-400', 'text-indigo-400');
                            analyzeStatus.classList.add('text-yellow-400');
                            showResults('<p class="text-sm text-yellow-400">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</p>');
                            return;
                        }

                        analyzeStatus.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å...';
                        analyzeStatus.classList.remove('text-green-400', 'text-red-400', 'text-yellow-400');
                        analyzeStatus.classList.add('text-indigo-400');

                        analyzeLog?.classList.add('hidden');
                        showLoader('–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∫–∞—Ä—Ç–æ—á–∫—É...');

                        const params = new URLSearchParams({
                            url: productUrl,
                            marketplace,
                            withCompetitors: String(withCompetitors)
                        });

                        // –¢–∞–π–º–∞—É—Ç 15 —Å–µ–∫—É–Ω–¥
                        const abortController = new AbortController();
                        const timeoutId = setTimeout(() => abortController.abort(), 15000);

                        try {
                            const response = await fetch(`/analyze?${params.toString()}`, {
                                signal: abortController.signal
                            });
                            clearTimeout(timeoutId);
                            const data = await response.json().catch(() => ({}));

                            if (!response.ok) {
                                const issue = data?.error || response.statusText || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                                throw new Error(issue);
                            }

                            analyzeStatus.textContent = '–ì–æ—Ç–æ–≤–æ: –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã';
                            analyzeStatus.classList.remove('text-indigo-400');
                            analyzeStatus.classList.add('text-green-400');
                            console.info('[MarketLens] analyze response', data);

                            const resultHtml = `
                                <div class="space-y-4">
                                    <div>
                                        <h3 class="text-lg font-semibold text-indigo-300">–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞</h3>
                                        <p class="text-sm text-gray-400">–ò—Å—Ç–æ—á–Ω–∏–∫: <span class="font-mono text-gray-200">${escapeHtml(data?.marketplace || marketplace)}</span></p>
                                    </div>
                                    <pre class="whitespace-pre-wrap break-words text-sm text-gray-200 bg-gray-900/60 border border-gray-700 rounded-xl p-4 overflow-x-auto">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
                                </div>
                            `;

                            showResults(resultHtml);
                        } catch (fetchError) {
                            clearTimeout(timeoutId);
                            if (fetchError.name === 'AbortError') {
                                throw new Error('–°–µ—Ä–≤–µ—Ä —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                            }
                            throw fetchError;
                        }
                    } catch (error) {
                        analyzeStatus.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
                        analyzeStatus.classList.remove('text-indigo-400');
                        analyzeStatus.classList.add('text-red-400');
                        console.error('[MarketLens] analyze request failed', error);

                        showResults(`<p class="text-red-400">–û—à–∏–±–∫–∞: ${escapeHtml(error?.message || String(error))}</p>`);
                    } finally {
                        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                        if (analyzeButton) analyzeButton.disabled = false;
                    }
                });
            }

            const formatPrice = (value) => {
                const num = Number(value);
                return Number.isFinite(num) ? `${num.toLocaleString('ru-RU')} ‚ÇΩ` : '‚Äî';
            };

            const formatRating = (value) => {
                const num = Number(value);
                return Number.isFinite(num) ? `${num.toFixed(1)} ‚òÖ` : '‚Äî';
            };

            const renderMarketplaceColumn = (marketplace, items) => {
                const labelMap = {
                    ozon: 'Ozon',
                    wildberries: 'Wildberries',
                    yandex_market: '–Ø–Ω–¥–µ–∫—Å –ú–∞—Ä–∫–µ—Ç'
                };

                if (!items || items.length === 0) {
                    return `
                        <article class="bg-gray-900/50 border border-gray-700/80 rounded-2xl p-5 flex flex-col gap-3">
                            <header class="flex items-center justify-between text-sm text-gray-400">
                                <span>${labelMap[marketplace] || marketplace}</span>
                                <span>‚Äî</span>
                            </header>
                            <p class="text-sm text-gray-500">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —ç—Ç–æ–π –ø–ª–æ—â–∞–¥–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
                        </article>
                    `;
                }

                const cards = items.slice(0, 3).map((item) => `
                    <article class="bg-gray-900/70 border border-gray-700/80 rounded-2xl p-5 flex flex-col gap-3">
                        <header class="flex items-center justify-between text-xs uppercase tracking-wide text-indigo-300">
                            <span>${escapeHtml(labelMap[item.marketplace] || item.marketplace)}</span>
                            <span class="text-gray-400">${escapeHtml(item.sku || '‚Äî')}</span>
                        </header>
                        <div class="space-y-2">
                            <a href="${escapeHtml(item.url || '#')}" target="_blank" rel="noopener" class="text-base font-semibold text-indigo-200 hover:text-indigo-100 break-words">${escapeHtml(item.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</a>
                            <dl class="grid grid-cols-2 gap-2 text-sm text-gray-300">
                                <div><dt class="text-gray-500">–¶–µ–Ω–∞</dt><dd class="font-medium">${formatPrice(item.price)}</dd></div>
                                <div><dt class="text-gray-500">–†–µ–π—Ç–∏–Ω–≥</dt><dd class="font-medium">${formatRating(item.rating)}</dd></div>
                                <div><dt class="text-gray-500">–û—Ç–∑—ã–≤—ã</dt><dd class="font-medium">${Number(item.reviews ?? 0).toLocaleString('ru-RU')}</dd></div>
                                <div><dt class="text-gray-500">–ë—Ä–µ–Ω–¥</dt><dd class="font-medium">${escapeHtml(item.brand || '‚Äî')}</dd></div>
                            </dl>
                        </div>
                    </article>
                `);

                return cards.join('');
            };

            if (searchForm) {
                const searchButton = searchForm.querySelector('.search-submit');
                searchForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    
                    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
                    if (searchButton) searchButton.disabled = true;

                    try {
                        const query = searchQuery?.value?.trim();
                        if (!query) {
                            searchStatus.textContent = '–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
                            searchStatus.classList.remove('text-green-400', 'text-red-400');
                            searchStatus.classList.add('text-yellow-400');
                            showResults('<p class="text-sm text-yellow-400">–î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∏—Å–∫.</p>');
                            return;
                        }

                        const marketplace = searchMarketplace?.value || '';
                        const limit = Number(searchLimit?.value || 5);

                        searchStatus.textContent = '–ò—â–µ–º —Ç–æ–ø–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏...';
                        searchStatus.classList.remove('text-green-400', 'text-red-400', 'text-yellow-400');
                        searchStatus.classList.add('text-indigo-400');

                        showLoader('–ò—â—É –ª–∏–¥–µ—Ä–æ–≤ —Ä—ã–Ω–∫–∞...');

                        const url = new URL('/search', API_BASE_URL);
                        if (marketplace) url.searchParams.set('marketplace', marketplace);
                        url.searchParams.set('query', query);
                        url.searchParams.set('limit', String(limit));

                        // –¢–∞–π–º–∞—É—Ç 15 —Å–µ–∫—É–Ω–¥
                        const abortController = new AbortController();
                        const timeoutId = setTimeout(() => abortController.abort(), 15000);

                        try {
                            const response = await fetch(url.toString(), {
                                signal: abortController.signal
                            });
                            clearTimeout(timeoutId);
                            const data = await response.json().catch(() => ({}));

                            if (!response.ok) {
                                const issue = data?.error || response.statusText || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                                throw new Error(issue);
                            }

                            searchStatus.textContent = `–ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${data?.count ?? 0}`;
                            searchStatus.classList.remove('text-indigo-400');
                            searchStatus.classList.add('text-green-400');
                            console.info('[MarketLens] search response', data);

                            const grouped = (data?.results || []).reduce((acc, item) => {
                                const mp = item.marketplace || 'unknown';
                                acc[mp] = acc[mp] || [];
                                acc[mp].push(item);
                                return acc;
                            }, {});

                            const marketplaces = marketplace ? [marketplace] : ['ozon', 'wildberries', 'yandex_market'];
                            const columnsHtml = marketplaces
                                .map((mp) => `<div class="flex flex-col gap-4">${renderMarketplaceColumn(mp, grouped[mp])}</div>`)
                                .join('');

                            const resultHtml = data?.results?.length
                                ? `
                                    <div class="space-y-4">
                                        <header class="space-y-1">
                                            <h3 class="text-lg font-semibold text-indigo-300">–õ–∏–¥–µ—Ä—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É ¬´${escapeHtml(query)}¬ª</h3>
                                            <p class="text-sm text-gray-400">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–æ —Ç—Ä—ë—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ –∫–∞–∂–¥–æ–π –ø–ª–æ—â–∞–¥–∫–µ.</p>
                                        </header>
                                        <div class="grid gap-6 md:grid-cols-3">${columnsHtml}</div>
                                    </div>
                                `
                                : '<p class="text-sm text-gray-400">–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É.</p>';

                            showResults(resultHtml);
                        } catch (fetchError) {
                            clearTimeout(timeoutId);
                            if (fetchError.name === 'AbortError') {
                                throw new Error('–°–µ—Ä–≤–µ—Ä —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                            }
                            throw fetchError;
                        }
                    } catch (error) {
                        searchStatus.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫';
                        searchStatus.classList.remove('text-indigo-400');
                        searchStatus.classList.add('text-red-400');
                        console.error('[MarketLens] search request failed', error);

                        showResults(`<p class="text-red-400">–û—à–∏–±–∫–∞: ${escapeHtml(error?.message || String(error))}</p>`);
                    } finally {
                        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                        if (searchButton) searchButton.disabled = false;
                    }
                });
            }

            if (monitoringForm) {
                const monitoringButton = monitoringForm.querySelector('.monitoring-submit');
                monitoringForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    
                    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
                    if (monitoringButton) monitoringButton.disabled = true;

                    try {
                        const productUrl = monitoringUrl?.value?.trim();
                        const marketplace = monitoringMarketplace?.value || 'ozon';
                        const notes = monitoringNotes?.value?.trim();

                        if (!productUrl) {
                            monitoringStatus.textContent = '–î–æ–±–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞';
                            monitoringStatus.classList.remove('text-green-400', 'text-indigo-400');
                            monitoringStatus.classList.add('text-yellow-400');
                            showResults('<p class="text-sm text-yellow-400">–£–∫–∞–∂–∏—Ç–µ —Å—Å—ã–ª–∫—É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥.</p>');
                            return;
                        }

                        monitoringStatus.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É...';
                        monitoringStatus.classList.remove('text-green-400', 'text-yellow-400', 'text-red-400');
                        monitoringStatus.classList.add('text-indigo-400');

                        showLoader('–î–æ–±–∞–≤–ª—è—é –≤ —Å–ø–∏—Å–æ–∫...');

                        // –¢–∞–π–º–∞—É—Ç 15 —Å–µ–∫—É–Ω–¥
                        const abortController = new AbortController();
                        const timeoutId = setTimeout(() => abortController.abort(), 15000);

                        try {
                            const response = await fetch('/monitoring/add', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    productUrl,
                                    marketplace,
                                    notes: notes || undefined
                                }),
                                signal: abortController.signal
                            });
                            clearTimeout(timeoutId);
                            const data = await response.json().catch(() => ({}));

                            if (!response.ok) {
                                const issue = data?.error || response.statusText || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                                throw new Error(issue);
                            }

                            monitoringStatus.textContent = '–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥';
                            monitoringStatus.classList.remove('text-indigo-400');
                            monitoringStatus.classList.add('text-green-400');
                            monitoringForm.reset();
                            console.info('[MarketLens] monitoring item created', data);

                            const successHtml = `
                                <div class="space-y-2">
                                    <p class="text-green-400 font-medium">–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è.</p>
                                    <p class="text-sm text-gray-400">–°—Å—ã–ª–∫–∞: <a href="${escapeHtml(productUrl)}" target="_blank" rel="noopener" class="text-indigo-300 hover:text-indigo-200">${escapeHtml(productUrl)}</a></p>
                                </div>
                            `;

                            showResults(successHtml);

                            if (monitoringList) {
                                monitoringList.classList.remove('hidden');
                                const entry = document.createElement('article');
                                entry.className = 'bg-gray-900/60 border border-gray-700 rounded-xl p-4 space-y-2';
                                entry.dataset.itemId = data.item?.id || '';
                                
                                // üß™ TEST 4.5: –î–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                                entry.dataset.status = data.item?.status || 'active';
                                
                                entry.innerHTML = `
                                    <div class="flex items-center justify-between text-xs text-gray-500">
                                        <span class="uppercase tracking-wide text-gray-400">${escapeHtml(marketplace)}</span>
                                        <span>${new Date().toLocaleString('ru-RU')}</span>
                                    </div>
                                    <a href="${escapeHtml(productUrl)}" target="_blank" rel="noopener" class="text-sm text-indigo-300 hover:text-indigo-200 break-words">${escapeHtml(productUrl)}</a>
                                    ${notes ? `<p class="text-sm text-gray-300">${escapeHtml(notes)}</p>` : ''}
                                    <div class="monitoring-card-status"></div>
                                `;
                                monitoringList.prepend(entry);
                                
                                // üß™ TEST 4.5: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
                                const checkUpdatesBtn = document.getElementById('check-updates-btn');
                                if (checkUpdatesBtn) checkUpdatesBtn.classList.remove('hidden');
                            }
                        } catch (fetchError) {
                            clearTimeout(timeoutId);
                            if (fetchError.name === 'AbortError') {
                                throw new Error('–°–µ—Ä–≤–µ—Ä —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                            }
                            throw fetchError;
                        }
                    } catch (error) {
                        monitoringStatus.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
                        monitoringStatus.classList.remove('text-indigo-400');
                        monitoringStatus.classList.add('text-red-400');
                        console.error('[MarketLens] monitoring request failed', error);

                        showResults(`<p class="text-red-400">–û—à–∏–±–∫–∞: ${escapeHtml(error?.message || String(error))}</p>`);
                    } finally {
                        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                        if (monitoringButton) monitoringButton.disabled = false;
                    }
                });
            }

            // üß™ TEST 4.5: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
            const checkUpdatesBtn = document.getElementById('check-updates-btn');
            if (checkUpdatesBtn) {
                checkUpdatesBtn.addEventListener('click', async () => {
                    checkUpdatesBtn.disabled = true;
                    checkUpdatesBtn.textContent = '–ü—Ä–æ–≤–µ—Ä—è—é...';
                    
                    try {
                        // TEST 3.2: –¢–∞–π–º–∞—É—Ç 15 —Å–µ–∫—É–Ω–¥
                        const abortController = new AbortController();
                        const timeoutId = setTimeout(() => abortController.abort(), 15000);
                        
                        try {
                            const response = await fetch('/monitoring/check-updates', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                signal: abortController.signal
                            });
                            clearTimeout(timeoutId);
                            
                            const data = await response.json();
                            
                            if (!response.ok) {
                                throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π');
                            }
                        
                            console.log('[MarketLens] Check updates result:', data);
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
                            const cards = monitoringList.querySelectorAll('article[data-item-id]');
                            
                            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
                            if (data.unavailable && data.unavailable.length > 0) {
                                data.unavailable.forEach(unavail => {
                                    const card = Array.from(cards).find(c => c.dataset.itemId === unavail.id);
                                    if (card) {
                                        card.dataset.status = 'unavailable';
                                        const statusDiv = card.querySelector('.monitoring-card-status');
                                        if (statusDiv) {
                                            statusDiv.innerHTML = `
                                                <div class="mt-2 p-3 bg-red-900/30 border border-red-700 rounded-lg">
                                                    <p class="text-sm font-semibold text-red-400">‚ö†Ô∏è –¢–æ–≤–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>
                                                    <p class="text-xs text-red-300 mt-1">${escapeHtml(unavail.reason || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ')}</p>
                                                </div>
                                            `;
                                        }
                                    }
                                });
                            }
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                            let message = `–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${data.checked}`;
                            if (data.updates && data.updates.length > 0) {
                                message += `\\n –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω: ${data.updates.length}`;
                            }
                            if (data.unavailableCount > 0) {
                                message += `\\n‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ: ${data.unavailableCount}`;
                            }
                            
                            monitoringStatus.textContent = message;
                            monitoringStatus.classList.remove('text-red-400', 'text-yellow-400');
                            monitoringStatus.classList.add('text-green-400');
                        } catch (fetchError) {
                            clearTimeout(timeoutId);
                            if (fetchError.name === 'AbortError') {
                                throw new Error('–°–µ—Ä–≤–µ—Ä —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                            }
                            throw fetchError;
                        }
                        
                    } catch (error) {
                        console.error('[MarketLens] Check updates failed:', error);
                        monitoringStatus.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                        monitoringStatus.classList.remove('text-green-400');
                        monitoringStatus.classList.add('text-red-400');
                    } finally {
                        checkUpdatesBtn.disabled = false;
                        checkUpdatesBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
                    }
                });
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è" –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã
            if (monitoringList && !monitoringList.classList.contains('hidden')) {
                if (checkUpdatesBtn) checkUpdatesBtn.classList.remove('hidden');
            }
        });

        // –°–ü–õ–≠–®-–°–ö–†–ò–ù
        window.addEventListener('load', () => {
            const splash = document.getElementById('splash-screen');
            setTimeout(() => {
                splash.style.opacity = '0';
                setTimeout(() => splash.classList.add('hidden'), 500);
            }, 1500);
        });
        
        // ... (–≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π JavaScript-–∫–æ–¥ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞) ...
    </script>
</body>
</html>
