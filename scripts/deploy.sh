#!/bin/bash

# ========================================
# MarketLens Deployment Script
# ========================================
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏

set -e  # –í—ã–π—Ç–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ

APP_DIR="/home/marketlens/marketlens"
BACKUP_SCRIPT="/home/marketlens/backup.sh"

echo "üöÄ MarketLens Deployment Script v1.0"
echo "===================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -d "$APP_DIR" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ü–∞–ø–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $APP_DIR"
    exit 1
fi

cd "$APP_DIR" || exit 1

# 1. –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
echo "üì¶ –®–∞–≥ 1/6: –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞..."
if [ -f "$BACKUP_SCRIPT" ]; then
    bash "$BACKUP_SCRIPT"
    echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω"
else
    echo "‚ö†Ô∏è  –°–∫—Ä–∏–ø—Ç –±—ç–∫–∞–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
fi
echo ""

# 2. –ü–æ–ª—É—á–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Git)
if [ -d ".git" ]; then
    echo "‚¨áÔ∏è  –®–∞–≥ 2/6: –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ Git..."
    git pull origin main
    echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω"
else
    echo "‚ö†Ô∏è  –®–∞–≥ 2/6: Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "   –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SCP/FTP"
    echo "   –ù–∞–∂–º–∏—Ç–µ Enter –∫–æ–≥–¥–∞ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã..."
    read -r
fi
echo ""

# 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –®–∞–≥ 3/6: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install --production
echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
echo ""

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–¥–∞
echo "üîç –®–∞–≥ 4/6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
if node -c server.js; then
    echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ server.js"
    exit 1
fi
echo ""

# 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PM2
echo "üîÑ –®–∞–≥ 5/6: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 reload ecosystem.config.js --env production
echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ"
echo ""

# 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
echo "üìä –®–∞–≥ 6/6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
sleep 3
pm2 status marketlens-api
echo ""

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health endpoint
echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ health check..."
if curl -f http://localhost:3000/health > /dev/null 2>&1; then
    echo "‚úÖ Health check OK"
else
    echo "‚ö†Ô∏è  Health check –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs"
fi
echo ""

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üìä –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   pm2 logs          - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏"
echo "   pm2 monit         - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
echo "   pm2 restart all   - –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫"
echo ""
