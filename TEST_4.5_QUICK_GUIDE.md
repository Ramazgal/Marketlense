# TEST 4.5: "Живой" Мониторинг - Быстрая инструкция

## DoD
**При проверке удалённого товара на его карточке появляется плашка "Товар недоступен"**

## Быстрый тест (3 минуты)

### Шаг 1: Запустите приложение
```powershell
node server.js
```

Откройте `index.html` в браузере

### Шаг 2: Добавьте несуществующий товар

1. Перейдите на вкладку **"Мониторинг"**
2. Введите URL несуществующего товара:
   ```
   https://www.ozon.ru/product/deleted-nonexistent-999999999
   ```
3. Выберите маркетплейс: **Ozon**
4. Нажмите **"Добавить в мониторинг"**

**Ожидаемое:** Товар добавлен в список (без плашки)

### Шаг 3: Проверьте обновления

1. Нажмите кнопку **"Проверить обновления"**
2. Дождитесь ответа (5-10 секунд)

**Ожидаемое:** ✅ На карточке товара появилась **красная плашка**:

```
┌─────────────────────────────────────┐
│ ⚠️ Товар недоступен                  │
│ Не удалось получить данные о товаре │
└─────────────────────────────────────┘
```

### Шаг 4: Проверьте статус

**В шапке мониторинга должно быть:**
```
Проверено товаров: 1
⚠️ Недоступно: 1
```

**Результат:**
- ✅ **PASS** — плашка появилась, DoD выполнен
- ❌ **FAIL** — плашки нет или статус не обновлён

---

## Дополнительный тест: Восстановление

### Сценарий: Товар снова стал доступен

1. Добавьте **реальный** товар в мониторинг
2. Проверьте обновления (должно быть ОК)
3. **Измените URL** на несуществующий (через DevTools):
   ```javascript
   const link = document.querySelector('article[data-item-id] a');
   link.href = 'https://www.ozon.ru/product/deleted-999';
   ```
4. Проверьте обновления → **плашка появилась** ✅
5. **Верните корректный URL:**
   ```javascript
   link.href = 'https://www.ozon.ru/product/real-12345';
   ```
6. Проверьте обновления → **плашка исчезла** ✅

**Ожидаемое:** Товар автоматически восстанавливается

---

## Чек-лист проверки

| Критерий | ✅/❌ |
|----------|------|
| **1. Плашка появляется** | ☐ |
| **2. Текст: "⚠️ Товар недоступен"** | ☐ |
| **3. Причина указана** | ☐ |
| **4. Цвет красный** | ☐ |
| **5. Статус обновлён (data-status="unavailable")** | ☐ |
| **6. Статистика показана ("⚠️ Недоступно: 1")** | ☐ |

**Результат:** ✅ PASS (все 6) / ❌ FAIL (хотя бы 1 не выполнен)

---

## Что проверяет тест?

### Backend (server.js)
- ✅ Обработка ошибки парсинга (товар удалён)
- ✅ Пометка товара статусом `status: 'unavailable'`
- ✅ Добавление метки времени `unavailableSince`
- ✅ Восстановление статуса при повторной доступности

### Frontend (index.html)
- ✅ Отображение красной плашки в UI
- ✅ Вывод причины недоступности
- ✅ Обновление статуса карточки (`data-status`)
- ✅ Статистика в шапке мониторинга

---

## Примеры

### ✅ Хорошо
```
Карточка товара:
┌────────────────────────────────┐
│ OZON        08.10.2025, 14:30  │
│ https://www.ozon.ru/.../999    │
│ Конкурент A (главный)          │
│                                │
│ ┌────────────────────────────┐ │
│ │ ⚠️ Товар недоступен        │ │
│ │ Не удалось получить данные │ │
│ └────────────────────────────┘ │
└────────────────────────────────┘

Статус: Проверено товаров: 1
        ⚠️ Недоступно: 1
```

### ❌ Плохо
```
Карточка товара:
┌────────────────────────────────┐
│ OZON        08.10.2025, 14:30  │
│ https://www.ozon.ru/.../999    │
│ Конкурент A (главный)          │
│                                │
│ (нет плашки) ❌                │
└────────────────────────────────┘

Статус: Проверено товаров: 1
        (нет информации о недоступных) ❌
```

---

## Логи сервера

**При пометке товара как недоступного:**
```
WARN: Failed to fetch fresh data { itemId: 'mon-123', url: 'https://...' }
WARN: Item marked as unavailable { itemId: 'mon-123', url: 'https://...' }
```

**При восстановлении:**
```
INFO: Item became available again { itemId: 'mon-123' }
```

---

## Что делать при FAIL?

### Проблема 1: Плашка не появляется

**Проверьте:**
1. **Backend:** Логи сервера содержат "Item marked as unavailable"?
2. **API:** Ответ `/monitoring/check-updates` содержит массив `unavailable`?
3. **Frontend:** Код обработки `data.unavailable` выполняется?

**Исправление:**
- Проверьте код в `index.html`, строки 650-665
- Убедитесь, что `statusDiv.innerHTML` устанавливается

---

### Проблема 2: Товар не восстанавливается

**Проверьте:**
1. **Backend:** Логи содержат "Item became available again"?
2. **Код:** Условие `if (item.status === 'unavailable')` срабатывает?

**Исправление:**
- Проверьте код в `server.js`, строки 670-675
- Убедитесь, что `item.status` сбрасывается на `'active'`

---

### Проблема 3: Ошибка крашит приложение

**Проверьте:**
- Ошибка парсинга обёрнута в `try-catch`?
- Логи содержат "Parse error" без Unhandled Exception?

**Исправление:**
- Добавьте `try-catch` в цикл `for (const item of items)` в `/monitoring/check-updates`

---

## Тестовый эндпоинт (для упрощения теста)

### Добавить в server.js:

```javascript
app.post('/monitoring/test-unavailable', asyncHandler(async (req, res) => {
  const { itemId } = req.body;
  const item = monitoringRegistry.get(itemId);
  
  if (!item) return res.status(404).json({ error: 'Товар не найден' });
  
  item.status = 'unavailable';
  item.unavailableSince = new Date().toISOString();
  monitoringRegistry.set(itemId, item);
  
  res.json({ message: 'Товар помечен как недоступный', item });
}));
```

### Использование:

```powershell
# Пометить товар как недоступный
Invoke-RestMethod -Uri "http://localhost:3000/monitoring/test-unavailable" -Method POST -Body (@{ itemId = "mon-123" } | ConvertTo-Json) -ContentType "application/json"
```

---

## Полная документация

[TEST_4.5_UNAVAILABLE_MONITORING.md](TEST_4.5_UNAVAILABLE_MONITORING.md) — 3 сценария, примеры, структура данных

---

**Время теста:** ~3 минуты (базовый) / ~10 минут (полный)  
**Тип:** Ручной тест (визуальная проверка UI)  
**Статус:** ✅ READY (функционал уже реализован)
